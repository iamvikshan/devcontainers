name: Check Base Image Updates

on:
  workflow_dispatch:
  schedule:
    # Run daily at 6 AM UTC to check for new base images
    - cron: "0 6 * * *"

env:
  GITHUB_REGISTRY: ghcr.io
  GITLAB_REGISTRY: registry.gitlab.com
  GL_USERNAME: vikshan

jobs:
  check-updates:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4.2.2
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_TOKEN }}

      - name: Setup Node, Bun and install dependencies
        uses: iamvikshan/.github/.github/actions/setup-node-bun@main

      - name: Check for base image updates
        id: check_updates
        run: |
          echo "UPDATES_FOUND=false" >> $GITHUB_ENV
          echo "UPDATE_DETAILS=" >> $GITHUB_ENV

          # Create script to check image updates
          cat > check_updates.ts << 'EOF'
          import axios from 'axios'

          interface DockerHubTag {
            name: string
            last_updated: string
            digest: string
          }

          interface DockerHubResponse {
            results: DockerHubTag[]
          }

          interface ImageInfo {
            image: string
            currentDigest: string
            latestDigest: string
            lastUpdated: string
            hasUpdate: boolean
          }

          async function getDockerHubDigest(image: string, tag: string = 'latest'): Promise<{ digest: string, lastUpdated: string }> {
            try {
              const response = await axios.get<DockerHubResponse>(
                `https://hub.docker.com/v2/repositories/${image}/tags`,
                {
                  params: { page_size: 100 }
                }
              )
              
              const latestTag = response.data.results.find(t => t.name === tag)
              return {
                digest: latestTag?.digest || '',
                lastUpdated: latestTag?.last_updated || ''
              }
            } catch (error) {
              console.error(`Error checking ${image}:`, error.message)
              return { digest: '', lastUpdated: '' }
            }
          }

          async function getCurrentDigest(image: string, tag: string = 'latest'): Promise<string> {
            try {
              // Get current digest from the built image
              const response = await axios.get(
                `https://ghcr.io/token?scope=repository:iamvikshan/devcontainers/${image}:pull`
              )
              
              const manifestResponse = await axios.get(
                `https://ghcr.io/v2/iamvikshan/devcontainers/${image}/manifests/${tag}`,
                {
                  headers: {
                    Authorization: `Bearer ${response.data.token}`,
                    Accept: 'application/vnd.docker.distribution.manifest.v2+json'
                  }
                }
              )
              
              return manifestResponse.headers['docker-content-digest'] || ''
            } catch (error) {
              console.error(`Error getting current digest for ${image}:`, error.message)
              return ''
            }
          }

          async function main() {
            const imagesToCheck = [
              { name: 'bun', baseImage: 'oven/bun' },
              { name: 'bun-node', baseImage: 'oven/bun' },
              { name: 'ubuntu-bun', baseImage: 'library/ubuntu' },
              { name: 'ubuntu-bun-node', baseImage: 'library/ubuntu' }
            ]
            
            const updates: ImageInfo[] = []
            
            for (const { name, baseImage } of imagesToCheck) {
              console.log(`Checking ${baseImage} for ${name}...`)
              
              const { digest: latestDigest, lastUpdated } = await getDockerHubDigest(baseImage)
              const currentDigest = await getCurrentDigest(name)
              
              const hasUpdate = latestDigest && currentDigest && latestDigest !== currentDigest
              
              updates.push({
                image: name,
                currentDigest: currentDigest.substring(0, 12),
                latestDigest: latestDigest.substring(0, 12),
                lastUpdated,
                hasUpdate
              })
              
              console.log(`${name}: ${hasUpdate ? 'UPDATE AVAILABLE' : 'UP TO DATE'}`)
            }
            
            const hasAnyUpdates = updates.some(u => u.hasUpdate)
            
            if (hasAnyUpdates) {
              console.log('UPDATES_FOUND=true')
              const updateDetails = updates
                .filter(u => u.hasUpdate)
                .map(u => `- **${u.image}**: ${u.currentDigest} â†’ ${u.latestDigest} (${new Date(u.lastUpdated).toLocaleDateString()})`)
                .join('\\n')
              
              console.log(`UPDATE_DETAILS=${updateDetails}`)
            } else {
              console.log('UPDATES_FOUND=false')
            }
          }

          main().catch(console.error)
          EOF

          # Run the check
          bun run check_updates.ts

      - name: Trigger release workflow if updates found
        if: env.UPDATES_FOUND == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            try {
              const response = await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'releases.yml',
                ref: 'main',
                inputs: {
                  reason: 'Base image updates detected'
                }
              })
              console.log('Successfully triggered release workflow due to base image updates')
            } catch (error) {
              console.error('Failed to trigger release workflow:', error.message)
              throw error
            }
