name: Check Base Images

on:
  schedule:
    # Run daily at 5 AM UTC to catch base image updates quickly
    - cron: "0 5 * * *"
  workflow_dispatch:
    inputs:
      force_check:
        description: "Force check even if no recent updates"
        required: false
        default: false
        type: boolean

env:
  GITHUB_REGISTRY: ghcr.io
  GITLAB_REGISTRY: registry.gitlab.com
  GL_USERNAME: vikshan

jobs:
  check-updates:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: read
      actions: write

    steps:
      - name: Checkout
        uses: actions/checkout@v5.0.0
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_TOKEN }}

      - name: Setup Bun and install dependencies
        uses: iamvikshan/.github/.github/actions/setup-bun@main

      - name: Check for base image updates
        id: check_updates
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
          FORCE_CHECK: ${{ github.event.inputs.force_check }}
        run: |
          echo "ðŸ” Checking for base image updates..."

          # Run comprehensive base image check with error handling
          set +e  # Don't exit on error
          RESULT=$(bun scripts/checkImages.ts --comprehensive --json-only 2>/dev/null)
          SCRIPT_EXIT_CODE=$?
          set -e  # Re-enable exit on error

          echo "ðŸ“‹ Base image check result: $RESULT"

          # Check if the script ran successfully
          if [ $SCRIPT_EXIT_CODE -ne 0 ]; then
            echo "âŒ Script failed with exit code $SCRIPT_EXIT_CODE"
            echo "ðŸ”„ Falling back to safe defaults..."
            HAS_UPDATES="false"
            AFFECTED_CONTAINERS=""
            UPDATE_COUNT="0"
          else
            # Validate that we have valid JSON
            if echo "$RESULT" | jq empty 2>/dev/null; then
              echo "âœ… Valid JSON received from script"
              
              # Parse the JSON result with error handling
              HAS_UPDATES=$(echo "$RESULT" | jq -r '.hasUpdates // false')
              AFFECTED_CONTAINERS=$(echo "$RESULT" | jq -r '.affectedContainers // [] | join(",")')
              UPDATE_COUNT=$(echo "$RESULT" | jq -r '.updateCount // 0')
              SCRIPT_SUCCESS=$(echo "$RESULT" | jq -r '.success // false')
              
              # Check if the script reported success
              if [ "$SCRIPT_SUCCESS" != "true" ]; then
                echo "âš ï¸  Script reported internal error"
                SCRIPT_ERROR=$(echo "$RESULT" | jq -r '.error // "Unknown error"')
                echo "Error details: $SCRIPT_ERROR"
                # Treat as no updates if there was an error
                HAS_UPDATES="false"
                AFFECTED_CONTAINERS=""
                UPDATE_COUNT="0"
              fi
            else
              echo "âŒ Invalid JSON received from script"
              echo "Raw output: $RESULT"
              # Try to extract JSON line as fallback
              JSON_LINE=$(echo "$RESULT" | grep "^{" | head -1 || echo "")
              if [ -n "$JSON_LINE" ] && echo "$JSON_LINE" | jq empty 2>/dev/null; then
                echo "ðŸ”„ Found valid JSON line, using fallback parsing"
                HAS_UPDATES=$(echo "$JSON_LINE" | jq -r '.hasUpdates // false')
                AFFECTED_CONTAINERS=$(echo "$JSON_LINE" | jq -r '.affectedContainers // [] | join(",")')
                UPDATE_COUNT=$(echo "$JSON_LINE" | jq -r '.updateCount // 0')
              else
                echo "ðŸ”„ Falling back to safe defaults due to parsing failure"
                HAS_UPDATES="false"
                AFFECTED_CONTAINERS=""
                UPDATE_COUNT="0"
              fi
            fi
          fi

          # Override if force check is enabled
          if [ "$FORCE_CHECK" = "true" ]; then
            echo "âš ï¸  Force check enabled - treating as having updates"
            HAS_UPDATES="true"
            if [ "$AFFECTED_CONTAINERS" = "" ]; then
              AFFECTED_CONTAINERS="bun,bun-node,ubuntu-bun,ubuntu-bun-node,gitpod-bun,gitpod-bun-node,gitpod-ubuntu-bun,gitpod-ubuntu-bun-node"
            fi
          fi

          echo "has_updates=$HAS_UPDATES" >> $GITHUB_OUTPUT
          echo "affected_containers=$AFFECTED_CONTAINERS" >> $GITHUB_OUTPUT
          echo "update_count=$UPDATE_COUNT" >> $GITHUB_OUTPUT

          if [ "$HAS_UPDATES" = "true" ]; then
            echo "ðŸ“¦ Base image updates detected for: $AFFECTED_CONTAINERS"
            echo "ðŸ”¢ Total updates: $UPDATE_COUNT"
            echo "ðŸš€ Will trigger release workflow to rebuild containers"
          else
            echo "âœ… All base images are up to date"
          fi

      - name: Trigger release workflow
        if: steps.check_updates.outputs.has_updates == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          AFFECTED_CONTAINERS: ${{ steps.check_updates.outputs.affected_containers }}
        run: |
          echo "ðŸš€ Triggering release workflow for base image updates..."
          echo "ðŸ“¦ Affected containers: $AFFECTED_CONTAINERS"

          # Trigger the release workflow via workflow_dispatch with base-image-update trigger
          curl -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/releases.yml/dispatches" \
            -d "{\"ref\":\"main\",\"inputs\":{\"trigger_reason\":\"Base image updates detected for: $AFFECTED_CONTAINERS\"}}"

          if [ $? -eq 0 ]; then
            echo "âœ… Release workflow triggered successfully"
            echo "ðŸ“‹ The release workflow will:"
            echo "   - Build updated containers with new base images"
            echo "   - Update all documentation (CHANGELOG, README, versions)"
            echo "   - Create a single comprehensive release commit"
          else
            echo "âŒ Failed to trigger release workflow"
            exit 1
          fi

      - name: No updates needed
        if: steps.check_updates.outputs.has_updates != 'true'
        run: |
          echo "âœ… No base image updates needed - all images are current"
          echo "ðŸ“Š Check completed at $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "ðŸ”„ Next automatic check: Tomorrow at 5:00 AM UTC"
          echo "âœ¨ Base image monitoring workflow completed successfully"

      - name: Cleanup on failure
        if: failure()
        run: |
          echo "âŒ Base image check workflow failed"
          echo "ðŸ” Checking git status..."
          git status || true
          echo "ðŸ“‹ Checking recent logs..."
          tail -50 /tmp/*.log 2>/dev/null || echo "No log files found"
